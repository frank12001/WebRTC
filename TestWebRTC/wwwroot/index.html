<html>
<head>
    <meta charset="utf8">
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>

</head>
<body>
    <h1> 使用 RTCPeerConnection 傳輸影像</h1>
    <!--加了 playsinline 標籤才能在 iphone 上正常執行-->
    <video id="myVideo" playsinline></video>
    <video id="remoteVideo1" playsinline></video>

    <div>
        <button id="startButton">Start</button>
        <button id="callButton">Call</button>
        <button id="hangupButton">Hang Up</button>
    </div>

    <script>
        console.log('js code start');
         var configuration = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }, { urls: "stun:23.21.150.121" }] };
         var pc = new RTCPeerConnection(configuration);
        //wss://signaling220190827034317.azurewebsites.net/ws
        //ws://localhost:5000/ws
        var uri = "ws://localhost:5000/ws";
        var output;
        var socket = new WebSocket(uri);
        socket.onopen =  e => {
            console.log("open");
            createOfferSDP(pc, offerSDP => {
                socket.send(JSON.stringify({
                    Operator: "SaveSDP",
                    Json: JSON.stringify(offerSDP)
                }));
            });
            pc.onicecandidate = evt => {
                if (!evt.candidate) return;
                socket.send(JSON.stringify({
                    Operator: "SaveCandidate",
                    Json: JSON.stringify(evt.candidate)
                }));
            };
            pc.ontrack = evt => {
                console.log("ontrack");
            };
            pc.onaddstream =  e => {
                console.log("onaddstream");
            };
        };
        socket.onclose = function (e) { console.log("closed"); };
        socket.onmessage = function (e) {
            //1. BroadcastSDP: save remote sdp & output my video on ny screen
            //2. save remote candidate
            //封包一定有 Operator 這個欄位
            console.log("Received: " + e.data);

            var packet = JSON.parse(e.data);
            switch (packet.Operator)
            {
                case "BroadcastSDP":
                    var sdp = packet.Json;                   
                    var answer = new RTCSessionDescription(sdp);
                    pc.setRemoteDescription(answer);   
                    //set my media
                    setMedia(pc);
                    break;
                case "SaveCandidate":
                    var candidate = packet.Json;
                    pc.addIceCandidate(new RTCIceCandidate(candidate));
                    break;
            }
        }; 
        socket.onerror = function (e) { console.log("Error: "+e.data); }; 

        //創建 SDP 並儲存至 pc 的 LocalDescription 中
        function createOfferSDP(pc,success) {
             //要 create offer 後， pc.onicecandidate 才會觸發
            var options = {
                offerToReceiveAudio: true,
                offerToReceiveVideo: true
            };
            pc.createOffer(
                offer => {
                    pc.setLocalDescription(offer, () => {
                        success(offer);
                    });
                }, e => { console.log(e) }, options);
        }
        //取得本地攝影機串流，並將串流放入本地組件及 Peer 組件
        function setMedia(pc) {
              var constraints = { audio: true, video: true };
                navigator.mediaDevices.getUserMedia(constraints)
                .then((stream) => {
                    pc.addStream(stream);
                    var myVideo = document.querySelector('#myVideo');
                    myVideo.srcObject = mediaStream;
                    myVideo.onloadedmetadata = function (e) {
                        myVideo.play();
                    };                 
                })
                .catch(function (err) { console.log(err.name + ": " + err.message); }); // 总是在最后检查错误
        }
    </script>
</body>
</html>